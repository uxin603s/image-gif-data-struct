<!DOCTYPE html>
<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.12.4.min.js"></script>
	<script src="dataURItoBlob.js"></script>
	<script src="index.js"></script>
	<script>
	angular.module("app",[]).controller("Ctrl",['$scope',function($scope){
		var image="data:image/gif;base64,R0lGODlhCgAKAJEAAP////8AAAAA/wAAACH5BAAAAAAALAAAAAAKAAoAAAIWjC2Zhyoc3DOgAnXslfqo3mCMBJFMAQA7";
		// var image="data:image/gif;base64,R0lGODlhCwAdAKIAAP8AAAD/AP//AI6OjgAAAP///wAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQEZAAAACwAAAAACwAdAAADMHi63N4jvkghretipSXTk/eM5CeaG9ehF5seoPOWNBPcz603em/3uAUwKPQ5drVkAgAh+QQEMgAAACwCAAsABwAQAAADGXgnrMsNyknhswq7zff4ziceYmmeoxmCRwIAIfkEBGQAAAAsAgACAAcAEAAAAxl4B6zLDcpJ4bMKu833+M4nHmJpnqMZgkcCADs=";		
		$scope.image=image;
		var image_string=image.split(',');
		var byteString = atob(image_string[1]);
		var mimeString = image_string[0].split(':')[1].split(';')[0];
		
		var binary_arr=[];
		for (var i = 0; i < byteString.length; i++) {
			var value=byteString.charCodeAt(i);
			binary_arr.push(value)
		}
		
		if(binary_arr.pop()!=59){//image end 3B
			throw "沒有圖片結尾";
		}
		var image_struct={
			format:get_format(binary_arr),
			width:get_canvas_edge(binary_arr),
			height:get_canvas_edge(binary_arr),
			globalColorTable:[],
		}
		var packed_field_result=packed_field(binary_arr,{
			globalColorTableFlag:1,
			colorResultion:3,
			sortFlag:1,
			globalColorTableSize:3,
		})
		if(packed_field_result.globalColorTableFlag==1){
			image_struct.globalColorTable=getColorTable(binary_arr,packed_field_result.globalColorTableSize);
		}
		// console.log(image_struct.globalColorTable)
		var bg_color_index=binary_arr.shift();
		var pixel_aspect_ratio=binary_arr.shift();
		// console.log(image_struct.globalColorTable)
		// console.log(image_struct)
		
		var start=Date.now();
		while(binary_arr.length){
			
			Extension_process(binary_arr);
			if(binary_arr[0]==44){//Image Descriptor
				ImageDescriptor(binary_arr);
				
				var dd=decode_byte(binary_arr);
				while(dd.length)
					console.log(dd.splice(0,image_struct.width).join(""))
			}
			
			if((Date.now()-start)/1000>1){
				binary_arr=binary_arr.map(function(value){
					return value.toString("16")
				})
				$scope.binary_arr=binary_arr;
				console.log("超過兩秒 無窮迴圈 ",binary_arr)
				break;
			}
		}
		
	}])
	
	$(document).ready(function(){
		$(".upload").change(function(e){
			var files=e.target.files;
			var reader = new FileReader();					
			reader.onload=function(e){
				$("textarea").val(e.target.result)
			};
			reader.readAsDataURL(files[0]);	
		})
	})
	</script>
</head>
<body>
	
	<input type="file" class="upload" />
	<textarea></textarea>
	<div ng-app="app" ng-controller="Ctrl">
	<img style="width:auto;" ng-src="{{image}}" />
	<div style="word-break: break-all;">
	{{binary_arr}}
	</div>
	</div>
</body>
</html>