<!DOCTYPE html>
<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.12.4.min.js"></script>
	<script src="dataURItoBlob.js"></script>
	<script src="index.js"></script>
	<script>
	angular.module("app",[]).controller("Ctrl",['$scope',function($scope){
		var image="data:image/gif;base64,R0lGODlhCgAKAJEAAP////8AAAAA/wAAACH5BAAAAAAALAAAAAAKAAoAAAIWjC2Zhyoc3DOgAnXslfqo3mCMBJFMAQA7";
		// var image="data:image/gif;base64,R0lGODlhCwAdAKIAAP8AAAD/AP//AI6OjgAAAP///wAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQEZAAAACwAAAAACwAdAAADMHi63N4jvkghretipSXTk/eM5CeaG9ehF5seoPOWNBPcz603em/3uAUwKPQ5drVkAgAh+QQEMgAAACwCAAsABwAQAAADGXgnrMsNyknhswq7zff4ziceYmmeoxmCRwIAIfkEBGQAAAAsAgACAAcAEAAAAxl4B6zLDcpJ4bMKu833+M4nHmJpnqMZgkcCADs=";		
		$scope.image=image;
		var image_string=image.split(',');
		var byteString = atob(image_string[1]);
		var mimeString = image_string[0].split(':')[1].split(';')[0];
		
		var binary_arr=[];
		for (var i = 0; i < byteString.length; i++) {
			var value=byteString.charCodeAt(i);
			binary_arr.push(value)
		}
		var image_struct={
			pointer:0,
		}
		
		getData(binary_arr,image_struct,6,"format","getFormat");
		getData(binary_arr,image_struct,2,"width","getEdge");
		getData(binary_arr,image_struct,2,"height","getEdge");
		getData(binary_arr,image_struct,1,"packedField","getPackedField",{
			globalColorTableFlag:1,
			colorResultion:3,
			sortFlag:1,
			globalColorTableSize:3,
		});
		getData(binary_arr,image_struct,1,"bgColorIndex","getEdge");
		getData(binary_arr,image_struct,1,"pixelAspectRatio","getEdge");
		if(image_struct.packedField.value.globalColorTableFlag==1){
			var size=image_struct.packedField.value.globalColorTableSize;
			var count=Math.pow(2,parseInt(size,2)+1)*3;
			getData(binary_arr,image_struct,count,"globalColorTable","getColorTable");
		}
		var start=Date.now();
		var count=0;
		while(true){
			var first=binary_arr[image_struct.pointer];
			var second=binary_arr[image_struct.pointer+1];
			if(first==33){
				var second_check_arr={
					1:"PlainTextExtension",249:"GraphicsControlExtension",254:"CommentExtension",255:"ApplicationExtension",
				};
				if(second_check_arr[second]){
					// getData(binary_arr,image_struct,second_check_arr[second]);
				}
			}
			
			if(first==44){
				
				
			}
			
			if(first==59){
				break;
			}
			if((Date.now()-start)/1000>1){
				console.log("超過兩秒 無窮迴圈 ",binary_arr)
				break;
			}
			count++;
		}

		// getData(binary_arr,image_struct,1,"bgColorIndex","ExtensionProcess");
		// ExtensionProcess(binary_arr,image_struct);
		return 
		// if(binary_arr.pop()!=59){//image end 3B
			// throw "沒有圖片結尾";
		// }
			
		console.log(image_struct)
		var ggwp=[]
		var start=Date.now();
		while(binary_arr.length){
			
			Extension_process(binary_arr,image_struct);
			if(binary_arr[0]==44){//Image Descriptor
				var qq=ImageDescriptor(binary_arr);
				qq.shift();
				var local_image={
					left:get_canvas_edge(qq),
					top:get_canvas_edge(qq),
					width:get_canvas_edge(qq),
					height:get_canvas_edge(qq),
				}
				
				console.log(qq,local_image)
				var dd=decode_byte(binary_arr);
				var canvas=[];
				while(dd.length){
					var tmp=dd.splice(0,local_image.width);
					// console.log(tmp);
					canvas.push(tmp);
				}
				ggwp.push(canvas)
			}
			
			
		}
		$scope.image_struct=image_struct;
		$scope.ggwp=ggwp;
	}])
	
	$(document).ready(function(){
		$(".upload").change(function(e){
			var files=e.target.files;
			var reader = new FileReader();					
			reader.onload=function(e){
				$("textarea").val(e.target.result)
			};
			reader.readAsDataURL(files[0]);	
		})
	})
	</script>
</head>
<body>
	
	<input type="file" class="upload" />
	<textarea></textarea>
	<div ng-app="app" ng-controller="Ctrl">
		<img style="width:auto;" ng-src="{{image}}" />
		<div style="word-break: break-all;">
		{{binary_arr}}
		</div>
		<div>
			<div 
			style="
			display:inline-block;
			width:10px;height:10px;
			background:rgb({{block.join(',')}});
			" 
			ng-repeat="block in image_struct.globalColorTable">
			</div>
		</div>
		<div style="display:inline-block;vertical-align: top;" ng-repeat="pic in ggwp">
			<div style="height:10px;vertical-align: top;" ng-repeat="pic_line in pic">
				<div 
				style="
				vertical-align: top;
				display:inline-block;
				width:10px;height:10px;
				background:rgb({{image_struct.globalColorTable[pic_line_block].join(',')}});
				" 
				ng-repeat="pic_line_block in pic_line track by $index">
				
				</div>
			</div>
		</div>
	</div>
</body>
</html>